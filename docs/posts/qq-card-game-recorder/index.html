<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>QQ双扣记牌器实现 &ndash; YYX's Website</title>

    <!-- Meta -->
    <meta name="description" content="YYX's Website &ndash; ">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Social -->
    <meta property="article:author" content="YYX" />
    <meta property="article:section" content="Security" />
    <meta property="article:published_time" content="2015-05-12" />

    <meta property="og:type" content="article"/>
    <meta property="og:title" content="QQ双扣记牌器实现"/>
    <meta property="og:description" content="本文讨论了腾讯QQ游戏大厅新双扣角色版记牌器的设计、数据抓取的思路及方法以及最终记牌器的实现细节。"/>
    <meta property="og:site_name" content="YYX's Website" />
    <meta property="og:url" content="../../posts/qq-card-game-recorder/"/>

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="QQ双扣记牌器实现">
    <meta name="twitter:description" content="本文讨论了腾讯QQ游戏大厅新双扣角色版记牌器的设计、数据抓取的思路及方法以及最终记牌器的实现细节。">
    <meta name="twitter:url" content="../../posts/qq-card-game-recorder/">

    <!-- Feed -->

    <!-- CSS -->
    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:regular,bold" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../../theme/css/w3.css">
    <link rel="stylesheet" type="text/css" href="../../theme/css/csshake.min.css">
    <link rel="stylesheet" type="text/css" href="../../theme/css/style.css">
    <!-- <link rel="stylesheet" type="text/css" href="../../theme/css/jqcloud.css"> -->
    <link rel="stylesheet" type="text/css" href="../../theme/css/font-awesome.min.css">
    <!-- <link rel="stylesheet" type="text/css" href="../../theme/css/pygments-highlight-github.css"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow-night-eighties.min.css">

    <!-- Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/theme/images/favicon-32x32.png">

    <!-- JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <!-- <script src="../../theme/js/jqcloud.min.js"></script> -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="../../theme/js/main.js"></script>
  </head>

  <body>
    <div class="w3-row w3-white">
      <header id="header">
        <a href="../../" id="header-logo" title="Home"><img class="shake-crazy" src="../../theme/images/logo_min.svg" width="50" height="50"></a>
        <!-- <a href="../.." id="header-logo" title="Home">Y</a> -->
        <nav id="header-menu">
          <a class="w3-bar-item w3-button w3-right w3-hide-large w3-hide-medium" id="nav-expand-btn" href="javascript:void(0)"><i class="fa fa-bars" aria-hidden="true"></i></a>
          <ul class="w3-hide-small">
            <!-- category -->
            <!-- list -->
            <!-- menu item -->
            <li class="w3-border-white w3-hover-opacity"><a href="/posts/">Posts</a></li>
            <li class="w3-border-white w3-hover-opacity"><a href="/gallery/">Gallery</a></li>
            <li class="w3-border-white w3-hover-opacity"><a href="/about/">About</a></li>
            <!-- pages -->
          </ul>
        </nav>
      </header>
    </div>



    <article class="w3-padding-64">
      <header class="w3-container col-main">
        <h1>QQ双扣记牌器实现</h1>
        <div class="post-info">
          <div class="w3-opacity w3-margin-right w3-margin-bottom" style="flex-grow: 1;">
            <span><time datetime="2015-05-12T01:17:00-07:00">May 12, 2015</time> @ <a href="../../categories/security/" title="All articles in category Security">Security</a></span>
          </div>
          <div class="w3-margin-right">
            <span class="w3-tag w3-hover-light-grey yyx-text-yellow yyx-tag-transparent">
              <a href="../../tags/crack/" title="All articles with Crack tag">#crack</a>
            </span>
            <span class="w3-tag w3-hover-light-grey yyx-text-yellow yyx-tag-transparent">
              <a href="../../tags/reversing/" title="All articles with Reversing tag">#reversing</a>
            </span>
            <span class="w3-tag w3-hover-light-grey yyx-text-yellow yyx-tag-transparent">
              <a href="../../tags/cheater/" title="All articles with Cheater tag">#cheater</a>
            </span>
            <span class="w3-tag w3-hover-light-grey yyx-text-yellow yyx-tag-transparent">
              <a href="../../tags/game/" title="All articles with Game tag">#game</a>
            </span>
            <span class="w3-tag w3-hover-light-grey yyx-text-yellow yyx-tag-transparent">
              <a href="../../tags/qq/" title="All articles with Qq tag">#QQ</a>
            </span>
            <span class="w3-tag w3-hover-light-grey yyx-text-yellow yyx-tag-transparent">
              <a href="../../tags/ji-pai-qi/" title="All articles with 记牌器 tag">#记牌器</a>
            </span>
            <span class="w3-tag w3-hover-light-grey yyx-text-yellow yyx-tag-transparent">
              <a href="../../tags/you-xi/" title="All articles with 游戏 tag">#游戏</a>
            </span>
            <span class="w3-tag w3-hover-light-grey yyx-text-yellow yyx-tag-transparent">
              <a href="../../tags/qi-pai/" title="All articles with 棋牌 tag">#棋牌</a>
            </span>
          </div>
        </div>
      </header>


      <div class="col-main w3-container">
        <section id="content" class="w3-margin-bottom w3-padding-8">
          <h1>吐槽</h1>
<p>到USC刷master真可谓“玩命”读书，在学校被大神虐，在路上怕被黑哥虐，出去玩耍被款爷虐，逢年过节被秀恩爱的虐，总之就是各种不择手段花式虐狗。再加上这学期悲剧的选课，期末下来，已经基本气绝。考闭，准备打打牌找找乐子，作为杭州人，当然最爱双扣，但是当你发现双扣竟然在4月底被企鹅的程序猿改的面目全非之后，就有种气急败坏的却又无从抱怨的感觉。</p>
<p>也不知道怎么想的，突然很想搞一个自己的记牌器玩玩（我承认这儿转折很突兀，因为我自己也不知道为什么当时还没来得及拍脑门就决定了），最后竟然三天抛出成品（不可避免有小bug），于是决定撰文记录一下，行文就按照日子来了。</p>
<p>我这边测试的双扣可执行文件skrpg.exe的文件版本是2.0.107.14，MD5为1c6d85c0accf6ce1a834e947e5467412。很可能游戏更新后数据会有所不同（新版本刚出来更新会特别频繁），但是思路不变的，你需要再机械劳动一次更新所有数据。</p>
<h1>Day1 抓数据</h1>
<p>其实第一天的时候还没决定真的做出个记牌器，就想研究下这玩意是怎么实现的（好奇心害死猫）。</p>
<p>记牌器实现基本是两种思路：</p>
<ul>
<li>第一种是图形匹配，就是抓窗口的牌面，其实这儿做匹配还是很简单的，毕竟牌面的样子是不会变的，也不需要什么复杂的匹配算法，只要弄下来所有牌面搞个数据库，直接就可以匹配得到数据。难度在于，窗口是可以缩放的，因此牌桌大小不固定，牌的相对位置不清楚是不是按照比例算的；另外，新版双扣是所谓的角色版，添加了一些动画效果，这些效果出现的时候会覆盖一部分牌面，而且是动态的，因此这个时候抓取牌面就不是一种一成不变的情况。</li>
<li>第二种是抓数据，这种没有第一种直观，很多时候需要靠推理和碰运气去猜测数据保存在内存中的形式，当然如果数据在内存中被加密了，那就更倒霉了。但是一旦能正确抓出数据并解码，实现就非常简单，而且正确率是100%。当然抓数据不局限于内存数据，很多时候可能是网络数据，那就需要抓包啦。</li>
</ul>
<p>我选了第二种，抓取工具是Cheat Engine，直接从内存抓取。首先初步判断下需要抓取的数据：所有玩家的当前剩余的牌数，所有玩家每次出的牌，自己的座位，发牌后自己的牌（你一定得不到别人的牌面，这些都在服务器上，如果你能得到那就直接做作弊器了）。</p>
<h2>玩家剩余牌数</h2>
<p>这是思路最简单且最好抓的一步。一个思维正常的程序猿一般都会用整数类型来记录，也就是有符号整形，因此直接抓DWORD长度数据，根据牌数量变化，不断缩小范围，依次在内存中找出4个玩家的剩余牌数位置，找到位置后用CE查找谁access/write了这些位置，这就是我们要找的地址。</p>
<div class="highlight"><pre><span></span><code>DOWN:   &quot;GameLogic.dll&quot;+3CF20
LEFT:   &quot;GameLogic.dll&quot;+3CE30
UP:     &quot;GameLogic.dll&quot;+3D100
RIGHT:  &quot;GameLogic.dll&quot;+3D010
</code></pre></div>

<p>这里的的DOWN、LEFT、UP、RIGHT是我用来表示玩家的座位的，这些座位是大厅中座位的绝对位置，理解这点很重要。从拿到这些数据来看，这些位置是静态的（相对GameLogic.dll加载基址的偏移），So easy!</p>
<h2>自身座位号</h2>
<p>这是一个比较奇葩但必须解决的问题。还是假设企鹅的程序猿是不脑残的，那座位号应该是设计成连续排布的，可能是0-3，也可能是1-4（当然如果是个标准程序猿应该选前者，除非他是base为1的VB党），座位号的排列可能是顺时针，也可能是逆时针，当然还有可能跳着排列（这个可能性很小）。于是排列组合一下，每种情况起始位置可能有4种，算上顺时针逆时针就是有4x2=8种，所以0-3和1-4在连续排布情况下有16种可能性。在云计算的年代，16是个多么渺小的数据，直接brutal force，每种测试一次就行。测试方法就是选取16种中的一种，假设当前这个case成立，那这个座位应该是X，进入下一个座位，应该是Y，这样依次测试，如果每次抓出来的数据都符合判断，就是这个case了。</p>
<div class="highlight"><pre><span></span><code>  2
1   3
  0
</code></pre></div>

<p>最后得到的结果是上面这种情况，0是DOWN，1是LEFT，2是UP，3是RIGHT，这些位置依然是大厅中的绝对位置。这里要提一句，找座位的时候可能会找到一个地址，每次都自增1，当时我还以为是这个，后来发现换了超过4个座位后它的数据依然在增长，测试后发现它是用来记录玩家在这桌入座了几次，不知企鹅程序猿设计这个数据有什么用……</p>
<p>我天真的以为座位号确定了，那座位号在内存中的位置也就确定了。但是当我点进去看access的地址处的反汇编的时候：</p>
<div class="highlight"><pre><span></span><code><span class="mf">02</span><span class="n">D30214</span> <span class="o">-</span> <span class="mf">8</span><span class="n">B</span> <span class="mf">4</span><span class="n">D</span> <span class="n">F4</span>  <span class="o">-</span> <span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span><span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mf">0</span><span class="n">C</span><span class="err">]</span>
<span class="mf">02</span><span class="n">D30217</span> <span class="o">-</span> <span class="mf">8</span><span class="n">B</span> <span class="mf">55</span> <span class="n">F8</span>  <span class="o">-</span> <span class="n">mov</span> <span class="n">edx</span><span class="p">,</span><span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mf">08</span><span class="err">]</span>
<span class="mf">02</span><span class="n">D3021A</span> <span class="o">-</span> <span class="mf">89</span> <span class="mf">14</span> <span class="mf">88</span>   <span class="o">-</span> <span class="n">mov</span> <span class="err">[</span><span class="n">eax</span><span class="o">+</span><span class="n">ecx</span><span class="o">*</span><span class="mf">4</span><span class="err">]</span><span class="p">,</span><span class="n">edx</span> <span class="o">&lt;&lt;</span>
<span class="mf">02</span><span class="n">D3021D</span> <span class="o">-</span> <span class="mf">6</span><span class="n">A</span> <span class="mf">01</span> <span class="o">-</span> <span class="n">push</span> <span class="mf">01</span>
<span class="mf">02</span><span class="n">D3021F</span> <span class="o">-</span> <span class="mf">66</span> <span class="mf">8</span><span class="n">B</span> <span class="mf">45</span> <span class="n">F4</span>  <span class="o">-</span> <span class="n">mov</span> <span class="n">ax</span><span class="p">,</span><span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mf">0</span><span class="n">C</span><span class="err">]</span>
</code></pre></div>

<p>很遗憾，这玩意地址不是固定的，因此需要找它的指针，很可能还要找它指针的指针，甚至更多层。当我找了两层之后，发现依然是变化的地址。无奈调出IDA完整的看了下这段反汇编，发现竟然是基于ebp的传入参数，因此是不固定的。此时突然想到CE有个自动找指针的功能，于是请出这个牛X的大杀器，瞬间1个G的指针数据就算出来了（这凭人手来找得找到什么时候），发现竟然有5层左右的指针调用，还都是不同基址的，筛选下2-3层的调用，找到一个相对可以接受的偏移：<code>[[["GameLogic.dll"+3DCB4]+88]+4]</code>，而且基址和前面算玩家剩余牌数的一致，Perfect!</p>
<h2>牌面数据</h2>
<p>牌面数据的推断简直就是拼脑洞。初步想一下牌面可能涉及到数据是花色和点数，虽然花色在双扣中是没有意义的，但是对于游戏的显示来说，花色是必须要的，因为花色是牌属性的一部分。当你想到这儿的时候你会发现，牌的存储很可能是一个自定义的数据类型，而这个类型的格式是不知道的，自定义格式中每个字段长度也是不知道的，双扣有两副牌，因此包含大小王在内有等于或超过两张以上的重复牌，每次出牌数量是不确定的，因此也不知道此时内存中牌有几张，这一组牌用什么方式被表示。我凭借自认为碉堡的智商在脑洞大开的情况下猜测了几次，发现这个捷径走不了，老老实实开IDA看反汇编去……</p>
<p>首先判断牌面的数据处理应该也是在GameLogic.dll中，直接分析这个模块文件，当然一般情况下不可能从头看反汇编，这样的搜索效率太低了。查看一下模块的导出表，没有有价值的函数入口，于是从字符串找突破口。字符串中出现诸如<code>CCardsGameLogic::OnGameStart\n</code>样子的函数名，点进去发现是回调函数，还有类似<code>RefreshCardsInHand\n</code>的debug用的字符串，不过这些位置的上下文都没有提供有价值的信息。又尝试了一些方式都没有很好的突破口，但是作为一个懒人，怎么能向从头刷代码那么low的方式低头呢？于是准备继续开脑洞……</p>
<p>猜测一下特征数据。每副牌54张，双扣一共2副牌108张，4个人打，每个人就是27张。初始化的时候应该会每个人发27张牌，那时候应该会有个循环分配这27张牌。于是直接在IDA中找立即数27，发现一处有价值的代码：</p>
<div class="highlight"><pre><span></span><code><span class="nl">.text:</span><span class="err">10020</span><span class="nf">D8C</span> <span class="c1">; int __stdcall sub_10020D8C(COleControl *)</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">D8C</span> <span class="no">sub_10020D8C</span>    <span class="no">proc</span> <span class="no">near</span>               <span class="c1">; CODE XREF: sub_10007D2E+97p</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">D8C</span>                                         <span class="c1">; sub_100081D9+151p ...</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">D8C</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">D8C</span> <span class="no">var_10</span>          <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="mi">-10</span><span class="no">h</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">D8C</span> <span class="no">var_C</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="mi">-0</span><span class="no">Ch</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">D8C</span> <span class="no">var_8</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="mi">-8</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">D8C</span> <span class="no">var_4</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="mi">-4</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">D8C</span> <span class="no">arg_0</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">8</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">D8C</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">D8C</span>                 <span class="no">push</span>    <span class="no">ebp</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">D8D</span>                 <span class="no">mov</span>     <span class="no">ebp</span><span class="p">,</span> <span class="no">esp</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">D8F</span>                 <span class="no">sub</span>     <span class="no">esp</span><span class="p">,</span> <span class="mi">10</span><span class="no">h</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">D92</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_10</span><span class="p">],</span> <span class="no">ecx</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">D95</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_0</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">D98</span>                 <span class="no">call</span>    <span class="no">sub_10034BF0</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">D9D</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_8</span><span class="p">],</span> <span class="no">eax</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DA0</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">],</span> <span class="mi">0</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DA7</span>                 <span class="no">jmp</span>     <span class="no">short</span> <span class="no">loc_10020DB2</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DA9</span> <span class="c1">; ---------------------------------------------------------------------------</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DA9</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DA9</span> <span class="no">loc_10020DA9</span><span class="p">:</span>                           <span class="c1">; CODE XREF: sub_10020D8C+68j</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DA9</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DAC</span>                 <span class="no">add</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">1</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DAF</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">],</span> <span class="no">eax</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DB2</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DB2</span> <span class="no">loc_10020DB2</span><span class="p">:</span>                           <span class="c1">; CODE XREF: sub_10020D8C+1Bj</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DB2</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_0</span><span class="p">]</span> <span class="c1">; this</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DB5</span>                 <span class="no">call</span>    <span class="err">?</span><span class="no">GetClientSite@COleControl@@QAEPAUIOleClientSite@@XZ</span> <span class="c1">; COleControl::GetClientSite(void)</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DBA</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">],</span> <span class="no">eax</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DBD</span>                 <span class="no">jge</span>     <span class="no">short</span> <span class="no">loc_10020DF6</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DBF</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">],</span> <span class="mi">1</span><span class="no">Bh</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DC3</span>                 <span class="no">jg</span>      <span class="no">short</span> <span class="no">loc_10020DF6</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DC5</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DC8</span>                 <span class="no">mov</span>     <span class="no">edx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_8</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DCB</span>                 <span class="no">movsx</span>   <span class="no">eax</span><span class="p">,</span> <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">edx</span><span class="err">+</span><span class="no">ecx</span><span class="p">*</span><span class="mi">4</span><span class="err">+</span><span class="mi">1</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DD0</span>                 <span class="no">push</span>    <span class="no">eax</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DD1</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_10</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DD4</span>                 <span class="no">call</span>    <span class="no">sub_10020DFE</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DD9</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_C</span><span class="p">],</span> <span class="no">eax</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DDC</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DDF</span>                 <span class="no">mov</span>     <span class="no">edx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_8</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DE2</span>                 <span class="no">mov</span>     <span class="no">al</span><span class="p">,</span> <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_C</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DE5</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">edx</span><span class="err">+</span><span class="no">ecx</span><span class="p">*</span><span class="mi">4</span><span class="err">+</span><span class="mi">3</span><span class="p">],</span> <span class="no">al</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DE9</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DEC</span>                 <span class="no">mov</span>     <span class="no">edx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_8</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DEF</span>                 <span class="no">mov</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">edx</span><span class="err">+</span><span class="no">ecx</span><span class="p">*</span><span class="mi">4</span><span class="err">+</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DF4</span>                 <span class="no">jmp</span>     <span class="no">short</span> <span class="no">loc_10020DA9</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DF6</span> <span class="c1">; ---------------------------------------------------------------------------</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DF6</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DF6</span> <span class="no">loc_10020DF6</span><span class="p">:</span>                           <span class="c1">; CODE XREF: sub_10020D8C+31j</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DF6</span>                                         <span class="c1">; sub_10020D8C+37j</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DF6</span>                 <span class="no">xor</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DF8</span>                 <span class="no">mov</span>     <span class="no">esp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DFA</span>                 <span class="no">pop</span>     <span class="no">ebp</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DFB</span>                 <span class="no">retn</span>    <span class="mi">4</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DFB</span> <span class="no">sub_10020D8C</span>    <span class="no">endp</span>
</code></pre></div>

<p>F5到C语言后关键部分是这样的：</p>
<div class="highlight"><pre><span></span><code><span class="p">...</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">COleControl</span><span class="o">::</span><span class="n">GetClientSite</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">27</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">v2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sub_10020DFE</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">v2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">v2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</code></pre></div>

<p>可以看出这类似于一个数组操作，而数组每个元素中至少有4个byte长度的值（可以看成是一个自定义数据类型），分别是：第0个不清楚，第3个是第1个经过运算的结果，第2个恒为0。点进去看表示第3个和第1个元素之间的函数<code>sub_10020DFE</code>：</p>
<div class="highlight"><pre><span></span><code><span class="nl">.text:</span><span class="err">10020</span><span class="nf">DFE</span> <span class="no">sub_10020DFE</span>    <span class="no">proc</span> <span class="no">near</span>               <span class="c1">; CODE XREF: sub_10020D8C+48p</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DFE</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DFE</span> <span class="no">var_8</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="mi">-8</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DFE</span> <span class="no">var_4</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="mi">-4</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DFE</span> <span class="no">arg_0</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">8</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DFE</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DFE</span>                 <span class="no">push</span>    <span class="no">ebp</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">DFF</span>                 <span class="no">mov</span>     <span class="no">ebp</span><span class="p">,</span> <span class="no">esp</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E01</span>                 <span class="no">sub</span>     <span class="no">esp</span><span class="p">,</span> <span class="mi">8</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E04</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_8</span><span class="p">],</span> <span class="no">ecx</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E07</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_0</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E0A</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">],</span> <span class="no">eax</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E0D</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_0</span><span class="p">],</span> <span class="mi">2</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E11</span>                 <span class="no">jnz</span>     <span class="no">short</span> <span class="no">loc_10020E1C</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E13</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">],</span> <span class="mi">0</span><span class="no">Eh</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E1A</span>                 <span class="no">jmp</span>     <span class="no">short</span> <span class="no">loc_10020E4B</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E1C</span> <span class="c1">; ---------------------------------------------------------------------------</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E1C</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E1C</span> <span class="no">loc_10020E1C</span><span class="p">:</span>                           <span class="c1">; CODE XREF: sub_10020DFE+13j</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E1C</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_0</span><span class="p">],</span> <span class="mi">1</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E20</span>                 <span class="no">jnz</span>     <span class="no">short</span> <span class="no">loc_10020E2B</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E22</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">],</span> <span class="mi">0</span><span class="no">Ch</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E29</span>                 <span class="no">jmp</span>     <span class="no">short</span> <span class="no">loc_10020E4B</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E2B</span> <span class="c1">; ---------------------------------------------------------------------------</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E2B</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E2B</span> <span class="no">loc_10020E2B</span><span class="p">:</span>                           <span class="c1">; CODE XREF: sub_10020DFE+22j</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E2B</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_0</span><span class="p">],</span> <span class="mi">0</span><span class="no">Eh</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E2F</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_10020E37</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E31</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_0</span><span class="p">],</span> <span class="mi">0</span><span class="no">Fh</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E35</span>                 <span class="no">jnz</span>     <span class="no">short</span> <span class="no">loc_10020E42</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E37</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E37</span> <span class="no">loc_10020E37</span><span class="p">:</span>                           <span class="c1">; CODE XREF: sub_10020DFE+31j</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E37</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E3A</span>                 <span class="no">add</span>     <span class="no">ecx</span><span class="p">,</span> <span class="mi">1</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E3D</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">],</span> <span class="no">ecx</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E40</span>                 <span class="no">jmp</span>     <span class="no">short</span> <span class="no">loc_10020E4B</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E42</span> <span class="c1">; ---------------------------------------------------------------------------</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E42</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E42</span> <span class="no">loc_10020E42</span><span class="p">:</span>                           <span class="c1">; CODE XREF: sub_10020DFE+37j</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E42</span>                 <span class="no">mov</span>     <span class="no">edx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E45</span>                 <span class="no">sub</span>     <span class="no">edx</span><span class="p">,</span> <span class="mi">2</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E48</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">],</span> <span class="no">edx</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E4B</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E4B</span> <span class="no">loc_10020E4B</span><span class="p">:</span>                           <span class="c1">; CODE XREF: sub_10020DFE+1Cj</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E4B</span>                                         <span class="c1">; sub_10020DFE+2Bj ...</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E4B</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E4E</span>                 <span class="no">mov</span>     <span class="no">esp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E50</span>                 <span class="no">pop</span>     <span class="no">ebp</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E51</span>                 <span class="no">retn</span>    <span class="mi">4</span>
<span class="nl">.text:</span><span class="err">10020</span><span class="nf">E51</span> <span class="no">sub_10020DFE</span>    <span class="no">endp</span>
</code></pre></div>

<p>这段翻译过来就是：</p>
<div class="highlight"><pre><span></span><code><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">第一个元素</span><span class="w"></span>
<span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">第三个元素</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="w"></span>
<span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">14</span><span class="w"></span>
<span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
</code></pre></div>

<p>这时候果断脑补：第一个元素可能是1~15，刚好是15种牌的点数（3~10，J，Q，K，A，2，小王F，大王Z）。假设第1个元素就是点数了，那第3个元素是什么呢？根据上面的算法画出对应的表：</p>
<div class="highlight"><pre><span></span><code><span class="gh">| 3 ~ K  |  A  |  2  |  F  |  Z  |</span>
<span class="gh">----------------------------------</span>
<span class="o">|</span> 1 ~ 11 |  12 |  14 |  15 |  16 |
</code></pre></div>

<p>有理由这样推测：第3个元素是用来比较牌的点数大小的，而至于为什么A和2之间空一个数，很可能是为顺子设计的，因为顺子只能从3连到A。</p>
<p>在验证猜想之前还需要做一件事，就是确定牌是按照从大到小还是从小到大排列的，同时确定大小比较是根据牌的点数数值（第1个元素）还是点数大小（第3个元素）决定的。只有四种可能性，依然直接穷举测试。打开CE，设定数据长度为byte，测试牌面点数。最后得到的结论是，牌在内存中是按照点数大小从大到小排列的（最大的牌是数组的起始）。在验证内存数据的过程中，同时确定了每张牌的存储空间是4bytes，前面没法确定的第0个元素实际上是花色：</p>
<div class="highlight"><pre><span></span><code>  王  黑桃  红桃  梅花  方片
-----------------------------
  0    1     2     3     4
</code></pre></div>

<p>至此，每张牌在内存中的表示方法已经确定：<code>[花色][点数][0][大小]</code>，每个属性各占1byte，每张牌占4bytes。无论所有玩家出的牌还是玩家自己的牌，只要找到最大一张牌的花色位置和牌的数量，根据每张牌占4bytes，就可以从内存中拿出这组牌数据。下面是我找到的各种情况下最大牌的起始位置（和找座位号时候确定指针的方法一致）：</p>
<div class="highlight"><pre><span></span><code>玩家手里的牌：     [[&quot;GameLogic.dll&quot;+3DAB8]+108]
下家最后出的牌:    [[&quot;GameLogic.dll&quot;+3DABC]+118]
上家最后出的牌:    [[&quot;GameLogic.dll&quot;+3DABC]+2f8]
左家最后出的牌:    [[&quot;GameLogic.dll&quot;+3DABC]+28]
右家最后出的牌:    [[&quot;GameLogic.dll&quot;+3DABC]+208]
</code></pre></div>

<p>所有基址基于GameLogic.dll，而且最后出的牌第一次偏移都是0x3DABC，Good job!</p>
<h1>Day2 实现逻辑</h1>
<p>工作量最大最烧脑的Day1过去了，Day2就轻松了很多。写代码之前当然是要确定语言啦，一般来说写外挂都用C++，毕竟要直接和Windows的API打交道。但是为了快（lan），我决定用Python……</p>
<h2>获取内存数据</h2>
<ul>
<li>首先找到游戏的进程，通过进程的可执行文件名skrpg.exe找到相应的进程pid（当然也可以通过窗口标题借助FindWindow来拿pid）。</li>
<li>根据pid执行OpenProcess。</li>
<li>由于地址偏移是根据GameLogic.dll这个模块确定的，因此需要读取该模块的基址：利用EnumProcessModulesEx得到所有已经加载的模块的句柄（注意权限为LIST_MODULES_ALL）</li>
<li>遍历模块句柄，使用GetModuleFileNameEx来得到模块名，找到GameLogic.dll，通过GetModuleInformation得到模块信息，lpBaseOfDll即为模块载入的基址。</li>
<li>通过ReadProcessMemory获取指定位置和长度的数据。</li>
</ul>
<p>很遗憾没有一个完整的库实现了这些API的Python封装，Pywin32也只实现了部分。所以我使用psutil库获取pid，其他都是通过ctype把Python数据转换成C的数据类型后直接调用系统API实现的（此处可以参考WinAppDbg的代码，很可惜它使用Python2.7实现，我用的是3.4，因此不能直接用这个库，需要提取和改写）。</p>
<h2>主逻辑</h2>
<p>当所有玩家剩余牌的数量为27时游戏开始，所有数量为0的时候游戏结束（测试发现当游戏结束的时候所有玩家牌会被瞬间置0）。<code>玩家每次出牌数量=上次手里剩下牌的数量-目前手里牌的数量</code>，当出牌数量不为0的时候（0是不出），则利用这个长度和最大牌的位置读取这组牌。</p>
<h1>Day3 界面实现</h1>
<p>既然上了Python的船，图形界面就顺理成章的PyQt了，反正Qt我还是比较熟的，PyQt用法差不了多少。这里要鄙视下PyQt的文档，大部分都依赖于Qt官网，你让只会Python不会C++的怎么搞？</p>
<p>程序设计为双线程，一个图形线程，一个工作线程，线程间通信通过Qt特有的Signal/Slot实现。</p>
<p>由于每个人对于记牌器最终功能设计的不一致，所以在写图形界面的时候也会有很大的差异。我目前粗略的实现了显示玩家剩余牌数、已经出的牌以及除了自己的牌以外还剩下的牌。</p>
<p>这边需要特别说明一下一个不可避免的问题：玩家的座位。当玩家入座后，无论他在游戏大厅中是哪个座位，他的位置一定是显示在最下面的。我上面一直强调无论是玩家剩余的牌数还是玩家打出去的牌，都是根据大厅中的绝对位置来确定的。所以这里涉及到计算相对座位的问题，公式其实很简单：<code>相对座位 = (座位-玩家自己的座位) MOD 4</code>。</p>
<p>最后上一张成品图：</p>
<p><img alt="record" src="/statics/qq-card-game-recorder/recorder.jpg"></p>
<h1>DayN 完善和后话</h1>
<p>找八阿哥（bug）当然是不可缺少的重要一步，不然怎么做第八个男人（Debug Man）呢？</p>
<p>QQ新双扣角色版的内存数据抓取总的来说没有碰到特别大的问题，主要还是因为数据没有加密，因此可以靠猜想和CE的辅助最终找到数据。GameLogic.dll也没有加壳，所以直接就能在IDA中看反汇编，相对也降低了破解的门槛。联网游戏的破解难度就是实时性，因此很难用OD之类的工具来下断点跟踪，所以推断的能力和阅读静态反汇编的能力需要加强。</p>
        </section>

        <br>

        <footer>
          <!-- <div class="adjust-width">
            <div id="author-block" class="w3-light-grey w3-border">
              <div id="author-info">
                <a href=""><img style="width: 60px; height: 60px;" src="/theme/images/cat_avatar.png" onerror="this.src='theme/images/avatar.png'" alt="Avatar"></a>
                <div style="margin-left: 20px; margin-top: 15px;">
                  <a href=""><span id="author-name" class="w3-hover-text-dark-grey">YYX</span></a>
                  <p id="author-story"></p>
                </div>
              </div>
            </div>
          </div>

          <br><br><br> -->

          <p style="font-size:10pt; font-style: italic;">Did you like this article? Share it with your friends!</p>
          <div id="share" class="share">
            <a href="http://www.facebook.com/sharer.php?u=../../posts/qq-card-game-recorder/&amp;t=YYX%27s%20Website%3A%20QQ%E5%8F%8C%E6%89%A3%E8%AE%B0%E7%89%8C%E5%99%A8%E5%AE%9E%E7%8E%B0" target="_blank" class="w3-btn yyx-btn-hover">
              <i class="fa fa-facebook"></i> <!-- <span>Facebook</span> -->
            </a>
            <a href="http://twitter.com/share?url=../../posts/qq-card-game-recorder/&amp;text=YYX%27s%20Website%3A%20QQ%E5%8F%8C%E6%89%A3%E8%AE%B0%E7%89%8C%E5%99%A8%E5%AE%9E%E7%8E%B0" target="_blank" class="w3-btn yyx-btn-hover">
              <i class="fa fa-twitter"></i> <!-- <span>Twitter</span> -->
            </a>
            <a href="https://plus.google.com/share?url=../../posts/qq-card-game-recorder/" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;" class="w3-btn yyx-btn-hover">
              <i class="fa fa-google-plus"></i> <!-- <span>Google</span> -->
            </a>
          </div>

          <br><br><br>



        </footer>
      </div>
    </article>


    <footer id="footer">
      <div id="footer-copyright" class="w3-center w3-text-grey w3-padding-48">
        <span>
          &copy;
          2014&dash;2021          yyx.me
 | <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank"><i class="fa fa-creative-commons" aria-hidden="true"></i></a>        </span>
      </div>
    </footer>


  </body>
</html>