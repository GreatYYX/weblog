<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>reversing.kr ImagePrc Walkthrough &ndash; YYX's Website</title>

    <!-- Meta -->
    <meta name="description" content="YYX's Website &ndash; ">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Social -->
    <meta property="article:author" content="YYX" />
    <meta property="article:section" content="Security" />
    <meta property="article:published_time" content="2014-09-23" />

    <meta property="og:type" content="article"/>
    <meta property="og:title" content="reversing.kr ImagePrc Walkthrough"/>
    <meta property="og:description" content="本文为逆向工程练习网站reversing.kr中ImagePrc解题攻略。"/>
    <meta property="og:site_name" content="YYX's Website" />
    <meta property="og:url" content="https://blog.yyx.me/posts/reversing-kr-imageprc/"/>

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="reversing.kr ImagePrc Walkthrough">
    <meta name="twitter:description" content="本文为逆向工程练习网站reversing.kr中ImagePrc解题攻略。">
    <meta name="twitter:url" content="https://blog.yyx.me/posts/reversing-kr-imageprc/">

    <!-- Feed -->
    <link rel="alternate" type="application/atom+xml" href="https://blog.yyx.me/feeds/all.atom.xml" title="YYX's Website Atom Feed" />
    <link rel="alternate" type="application/atom+xml" href="https://blog.yyx.me/feeds/{slug}.atom.xml" title="YYX's Website Categories Atom Feed" />
    <link rel="alternate" type="application/rss+xml" href="http://yyxblog.disqus.com/latest.rss" title="YYX's Website Comments RSS Feed">

    <!-- CSS -->
    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:regular,bold" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://blog.yyx.me/theme/css/w3.css">
    <link rel="stylesheet" type="text/css" href="https://blog.yyx.me/theme/css/csshake.min.css">
    <link rel="stylesheet" type="text/css" href="https://blog.yyx.me/theme/css/style.css">
    <!-- <link rel="stylesheet" type="text/css" href="https://blog.yyx.me/theme/css/jqcloud.css"> -->
    <link rel="stylesheet" type="text/css" href="https://blog.yyx.me/theme/css/font-awesome.min.css">
    <!-- <link rel="stylesheet" type="text/css" href="https://blog.yyx.me/theme/css/pygments-highlight-github.css"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow-night-eighties.min.css">

    <!-- Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/theme/images/favicon-32x32.png">

    <!-- JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <!-- <script src="https://blog.yyx.me/theme/js/jqcloud.min.js"></script> -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="https://blog.yyx.me/theme/js/main.js"></script>
  </head>

  <body>
    <div class="w3-row w3-white">
      <header id="header">
        <a href="https://blog.yyx.me/" id="header-logo" title="Home"><img class="shake-crazy" src="https://blog.yyx.me/theme/images/logo_min.svg" width="50" height="50"></a>
        <!-- <a href="https://blog.yyx.me" id="header-logo" title="Home">Y</a> -->
        <nav id="header-menu">
          <a class="w3-bar-item w3-button w3-right w3-hide-large w3-hide-medium" id="nav-expand-btn" href="javascript:void(0)"><i class="fa fa-bars" aria-hidden="true"></i></a>
          <ul class="w3-hide-small">
            <!-- category -->
            <!-- list -->
            <!-- menu item -->
            <li class="w3-border-white w3-hover-opacity"><a href="/posts/">Posts</a></li>
            <li class="w3-border-white w3-hover-opacity"><a href="/gallery/">Gallery</a></li>
            <li class="w3-border-white w3-hover-opacity"><a href="/about/">About</a></li>
            <!-- pages -->
          </ul>
        </nav>
      </header>
    </div>



    <article class="w3-padding-64">
      <header class="w3-container col-main">
        <h1>reversing.kr ImagePrc Walkthrough</h1>
        <div class="post-info">
          <div class="w3-opacity w3-margin-right w3-margin-bottom" style="flex-grow: 1;">
            <span><time datetime="2014-09-23T18:05:00-07:00">Sep 23, 2014</time> @ <a href="https://blog.yyx.me/categories/security/" title="All articles in category Security">Security</a></span>
          </div>
          <div class="w3-margin-right">
            <span class="w3-tag w3-hover-light-grey yyx-text-yellow yyx-tag-transparent">
              <a href="https://blog.yyx.me/tags/reversingkr/" title="All articles with Reversing.Kr tag">#reversing.kr</a>
            </span>
            <span class="w3-tag w3-hover-light-grey yyx-text-yellow yyx-tag-transparent">
              <a href="https://blog.yyx.me/tags/wargame/" title="All articles with Wargame tag">#wargame</a>
            </span>
            <span class="w3-tag w3-hover-light-grey yyx-text-yellow yyx-tag-transparent">
              <a href="https://blog.yyx.me/tags/hacking/" title="All articles with Hacking tag">#hacking</a>
            </span>
            <span class="w3-tag w3-hover-light-grey yyx-text-yellow yyx-tag-transparent">
              <a href="https://blog.yyx.me/tags/reversing/" title="All articles with Reversing tag">#reversing</a>
            </span>
          </div>
        </div>
      </header>


      <div class="col-main w3-container">
        <section id="content" class="w3-margin-bottom w3-padding-8">
          <h1>试玩</h1>
<p>看起来很有意思的一道题目。拿到后打开一个窗口，可以用鼠标画一些东西，之后点Check，弹出“Wrong”。直觉认为应该是要画出一个图像，正确的话会得到flag。可惜这个图能画正确的概率真的很低。</p>
<h1>逻辑分析</h1>
<p>OD打开之后下MessageBoxA的API断点或者WM_LBUTTONUP的消息断点，点击Check后断下并跟踪到核心逻辑代码的位置。</p>
<div class="highlight"><pre><span></span><code><span class="mf">004012</span><span class="n">D6</span>   <span class="o">&gt;</span> <span class="err">\</span><span class="mf">83</span><span class="n">BC24</span> <span class="mf">940000</span><span class="o">&gt;</span><span class="n">cmp</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">ss</span><span class="p">:</span><span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mf">0</span><span class="n">x94</span><span class="err">]</span><span class="p">,</span><span class="mf">0</span><span class="n">x64</span>         <span class="p">;</span>  <span class="n">Case</span> <span class="mf">111</span> <span class="p">(</span><span class="n">WM_COMMAND</span><span class="p">)</span> <span class="n">of</span> <span class="n">switch</span> <span class="mf">0040113</span><span class="n">A</span>
<span class="mf">004012</span><span class="n">DE</span>   <span class="mf">.</span>  <span class="mf">0</span><span class="n">F85</span> <span class="mf">01020000</span> <span class="n">jnz</span> <span class="n">ImagePrc</span><span class="mf">.004014E5</span>
<span class="mf">...</span>
<span class="mf">004013</span><span class="n">CD</span>   <span class="o">&gt;</span>  <span class="mf">8</span><span class="n">B8424</span> <span class="mf">900000</span><span class="o">&gt;</span><span class="n">mov</span> <span class="n">eax</span><span class="p">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="n">ss</span><span class="p">:</span><span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mf">0</span><span class="n">x90</span><span class="err">]</span>
<span class="mf">004013</span><span class="n">D4</span>   <span class="mf">.</span>  <span class="mf">6</span><span class="n">A</span> <span class="mf">30</span>         <span class="n">push</span> <span class="mf">0</span><span class="n">x30</span>                                <span class="p">;</span> <span class="o">/</span><span class="n">Style</span> <span class="o">=</span> <span class="n">MB_OK</span><span class="err">|</span><span class="n">MB_ICONEXCLAMATION</span><span class="err">|</span><span class="n">MB_APPLMODAL</span>
<span class="mf">004013</span><span class="n">D6</span>   <span class="mf">.</span>  <span class="mf">68</span> <span class="mf">34604000</span>   <span class="n">push</span> <span class="n">ImagePrc</span><span class="mf">.00406034</span>                   <span class="p">;</span> <span class="err">|</span><span class="n">ImagePrc</span>
<span class="mf">004013</span><span class="n">DB</span>   <span class="mf">.</span>  <span class="mf">68</span> <span class="mf">40604000</span>   <span class="n">push</span> <span class="n">ImagePrc</span><span class="mf">.00406040</span>                   <span class="p">;</span> <span class="err">|</span><span class="n">Wrong</span>
<span class="mf">004013</span><span class="n">E0</span>   <span class="mf">.</span>  <span class="mf">50</span>            <span class="n">push</span> <span class="n">eax</span>                                 <span class="p">;</span> <span class="err">|</span><span class="n">hOwner</span>
<span class="mf">004013</span><span class="n">E1</span>   <span class="mf">.</span>  <span class="n">FF15</span> <span class="n">F8504000</span> <span class="n">call</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">ds</span><span class="p">:</span><span class="err">[</span><span class="o">&lt;</span><span class="err">&amp;</span><span class="n">USER32</span><span class="mf">.</span><span class="n">MessageBoxA</span><span class="o">&gt;&gt;</span><span class="p">;</span> <span class="err">\</span><span class="n">MessageBoxA</span>
<span class="mf">004013</span><span class="n">E7</span>   <span class="mf">.</span>  <span class="mf">56</span>            <span class="n">push</span> <span class="n">esi</span>
<span class="mf">004013</span><span class="n">E8</span>   <span class="mf">.</span>  <span class="n">E8</span> <span class="mf">13010000</span>   <span class="n">call</span> <span class="n">ImagePrc</span><span class="mf">.00401500</span>
<span class="mf">004013</span><span class="n">ED</span>   <span class="mf">.</span>  <span class="mf">83</span><span class="n">C4</span> <span class="mf">04</span>       <span class="n">add</span> <span class="n">esp</span><span class="p">,</span><span class="mf">0</span><span class="n">x4</span>
<span class="mf">004013</span><span class="n">F0</span>   <span class="mf">.</span>  <span class="mf">33</span><span class="n">C0</span>          <span class="n">xor</span> <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
<span class="mf">004013</span><span class="n">F2</span>   <span class="mf">.</span>  <span class="mf">5</span><span class="n">B</span>            <span class="n">pop</span> <span class="n">ebx</span>
<span class="mf">004013</span><span class="n">F3</span>   <span class="mf">.</span>  <span class="mf">5</span><span class="n">F</span>            <span class="n">pop</span> <span class="n">edi</span>
<span class="mf">004013</span><span class="n">F4</span>   <span class="mf">.</span>  <span class="mf">5</span><span class="n">E</span>            <span class="n">pop</span> <span class="n">esi</span>
<span class="mf">004013</span><span class="n">F5</span>   <span class="mf">.</span>  <span class="mf">81</span><span class="n">C4</span> <span class="mf">80000000</span> <span class="n">add</span> <span class="n">esp</span><span class="p">,</span><span class="mf">0</span><span class="n">x80</span>
<span class="mf">004013</span><span class="n">FB</span>   <span class="mf">.</span>  <span class="n">C2</span> <span class="mf">1000</span>       <span class="n">retn</span> <span class="mf">0</span><span class="n">x10</span>
</code></pre></div>

<p>在按钮消息路由到弹出消息框之间就是我们要找的核心逻辑。下面分解一下逻辑：</p>
<div class="highlight"><pre><span></span><code><span class="p">...</span><span class="w"></span>
<span class="mf">004012E4</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="n">A1</span><span class="w"> </span><span class="n">F4844000</span><span class="w">   </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">ds</span><span class="p">:</span><span class="o">[</span><span class="n">0x4084F4</span><span class="o">]</span><span class="w"></span>
<span class="mf">004012E9</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">8</span><span class="n">D5424</span><span class="w"> </span><span class="mi">08</span><span class="w">     </span><span class="n">lea</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">ss</span><span class="p">:</span><span class="o">[</span><span class="n">esp+0x8</span><span class="o">]</span><span class="w"></span>
<span class="mi">004012</span><span class="n">ED</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">53</span><span class="w">            </span><span class="n">push</span><span class="w"> </span><span class="n">ebx</span><span class="w"></span>
<span class="mi">004012</span><span class="n">EE</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">52</span><span class="w">            </span><span class="n">push</span><span class="w"> </span><span class="n">edx</span><span class="w">                                 </span><span class="p">;</span><span class="w"> </span><span class="o">/</span><span class="n">Buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0018</span><span class="n">FB04</span><span class="w"></span>
<span class="mi">004012</span><span class="n">EF</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">6</span><span class="n">A</span><span class="w"> </span><span class="mi">18</span><span class="w">         </span><span class="n">push</span><span class="w"> </span><span class="mh">0x18</span><span class="w">                                </span><span class="p">;</span><span class="w"> </span><span class="o">|</span><span class="n">BufSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="p">(</span><span class="mf">24.</span><span class="p">)</span><span class="w"></span>
<span class="mi">004012</span><span class="n">F1</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">50</span><span class="w">            </span><span class="n">push</span><span class="w"> </span><span class="n">eax</span><span class="w">                                 </span><span class="p">;</span><span class="w"> </span><span class="o">|</span><span class="n">hObject</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">B9051E9B</span><span class="w"></span>
<span class="mi">004012</span><span class="n">F2</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="n">FF15</span><span class="w"> </span><span class="mi">1</span><span class="n">C504000</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">ds</span><span class="p">:</span><span class="o">[</span><span class="n">&lt;&amp;GDI32.GetObjectA&gt;</span><span class="o">]</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="err">\</span><span class="n">GetObjectA</span><span class="w"></span>
<span class="mi">004012</span><span class="n">F8</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="n">B9</span><span class="w"> </span><span class="mi">0</span><span class="n">A000000</span><span class="w">   </span><span class="n">mov</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="mh">0xA</span><span class="w"></span>
<span class="mi">004012</span><span class="n">FD</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">33</span><span class="n">C0</span><span class="w">          </span><span class="n">xor</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="n">eax</span><span class="w"></span>
<span class="mi">004012</span><span class="n">FF</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">8</span><span class="n">D7C24</span><span class="w"> </span><span class="mi">24</span><span class="w">     </span><span class="n">lea</span><span class="w"> </span><span class="n">edi</span><span class="p">,</span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">ss</span><span class="p">:</span><span class="o">[</span><span class="n">esp+0x24</span><span class="o">]</span><span class="w"></span>
<span class="mi">00401303</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">8</span><span class="n">D5424</span><span class="w"> </span><span class="mi">24</span><span class="w">     </span><span class="n">lea</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">ss</span><span class="p">:</span><span class="o">[</span><span class="n">esp+0x24</span><span class="o">]</span><span class="w"></span>
<span class="mi">00401307</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="nl">F3</span><span class="p">:</span><span class="n">AB</span><span class="w">         </span><span class="n">rep</span><span class="w"> </span><span class="n">stos</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">es</span><span class="p">:</span><span class="o">[</span><span class="n">edi</span><span class="o">]</span><span class="w"></span>
<span class="mi">00401309</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">8</span><span class="n">B4424</span><span class="w"> </span><span class="mi">14</span><span class="w">     </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">ss</span><span class="p">:</span><span class="o">[</span><span class="n">esp+0x14</span><span class="o">]</span><span class="w"></span>
<span class="mi">0040130</span><span class="n">D</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">8</span><span class="n">B4C24</span><span class="w"> </span><span class="mi">10</span><span class="w">     </span><span class="n">mov</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">ss</span><span class="p">:</span><span class="o">[</span><span class="n">esp+0x10</span><span class="o">]</span><span class="w"></span>
<span class="mi">00401311</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">8</span><span class="n">B3D</span><span class="w"> </span><span class="mi">20504000</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">edi</span><span class="p">,</span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">ds</span><span class="p">:</span><span class="o">[</span><span class="n">&lt;&amp;GDI32.GetDIBits&gt;&gt;;  GDI32.GetDIBits</span>
<span class="n">00401317   .  6A 00         push 0x0                                 ; /Usage = DIB_RGB_COLORS</span>
<span class="n">00401319   .  52            push edx                                 ; |pBitmapinfo</span>
<span class="n">0040131A   .  6A 00         push 0x0                                 ; |Buffer = NULL</span>
<span class="n">0040131C   .  894424 38     mov dword ptr ss:[esp+0x38</span><span class="o">]</span><span class="p">,</span><span class="n">eax</span><span class="w">          </span><span class="p">;</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="mi">00401320</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">50</span><span class="w">            </span><span class="n">push</span><span class="w"> </span><span class="n">eax</span><span class="w">                                 </span><span class="p">;</span><span class="w"> </span><span class="o">|</span><span class="n">nLines</span><span class="w"></span>
<span class="mi">00401321</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="n">A1</span><span class="w"> </span><span class="n">F4844000</span><span class="w">   </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">ds</span><span class="p">:</span><span class="o">[</span><span class="n">0x4084F4</span><span class="o">]</span><span class="w">          </span><span class="p">;</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="mi">00401326</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">894</span><span class="n">C24</span><span class="w"> </span><span class="mi">38</span><span class="w">     </span><span class="n">mov</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">ss</span><span class="p">:</span><span class="o">[</span><span class="n">esp+0x38</span><span class="o">]</span><span class="p">,</span><span class="n">ecx</span><span class="w">          </span><span class="p">;</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="mi">0040132</span><span class="n">A</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">8</span><span class="n">B0D</span><span class="w"> </span><span class="n">DC844000</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">ds</span><span class="p">:</span><span class="o">[</span><span class="n">0x4084DC</span><span class="o">]</span><span class="w">          </span><span class="p">;</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="mi">00401330</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">6</span><span class="n">A</span><span class="w"> </span><span class="mi">00</span><span class="w">         </span><span class="n">push</span><span class="w"> </span><span class="mh">0x0</span><span class="w">                                 </span><span class="p">;</span><span class="w"> </span><span class="o">|</span><span class="n">StartLine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">00401332</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">50</span><span class="w">            </span><span class="n">push</span><span class="w"> </span><span class="n">eax</span><span class="w">                                 </span><span class="p">;</span><span class="w"> </span><span class="o">|</span><span class="n">hBitmap</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">B9051E9B</span><span class="w"></span>
<span class="mi">00401333</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">51</span><span class="w">            </span><span class="n">push</span><span class="w"> </span><span class="n">ecx</span><span class="w">                                 </span><span class="p">;</span><span class="w"> </span><span class="o">|</span><span class="n">hDC</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">4</span><span class="n">C01191B</span><span class="w"></span>
<span class="mi">00401334</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="n">C74424</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="mi">280</span><span class="o">&gt;</span><span class="n">mov</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">ss</span><span class="p">:</span><span class="o">[</span><span class="n">esp+0x40</span><span class="o">]</span><span class="p">,</span><span class="mh">0x28</span><span class="w">         </span><span class="p">;</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="mi">0040133</span><span class="n">C</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">66</span><span class="err">:</span><span class="n">C74424</span><span class="w"> </span><span class="mi">4</span><span class="n">C</span><span class="w"> </span><span class="o">&gt;</span><span class="n">mov</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">ss</span><span class="p">:</span><span class="o">[</span><span class="n">esp+0x4C</span><span class="o">]</span><span class="p">,</span><span class="mh">0x1</span><span class="w">           </span><span class="p">;</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="mi">00401343</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">66</span><span class="err">:</span><span class="n">C74424</span><span class="w"> </span><span class="mi">4</span><span class="n">E</span><span class="w"> </span><span class="o">&gt;</span><span class="n">mov</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">ss</span><span class="p">:</span><span class="o">[</span><span class="n">esp+0x4E</span><span class="o">]</span><span class="p">,</span><span class="mh">0x18</span><span class="w">          </span><span class="p">;</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="mi">0040134</span><span class="n">A</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="n">C74424</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="mi">000</span><span class="o">&gt;</span><span class="n">mov</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">ss</span><span class="p">:</span><span class="o">[</span><span class="n">esp+0x50</span><span class="o">]</span><span class="p">,</span><span class="mh">0x0</span><span class="w">          </span><span class="p">;</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="mi">00401352</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="n">FFD7</span><span class="w">          </span><span class="k">call</span><span class="w"> </span><span class="n">edi</span><span class="w">                                 </span><span class="p">;</span><span class="w"> </span><span class="err">\</span><span class="n">GetDIBits</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</code></pre></div>

<p>程序首先获取绘制的对象，并提取绘制对象的像素内容。在<code>GetDIBits()</code>的时候栈情况如下：</p>
<div class="highlight"><pre><span></span><code>...
0018FADC   4C01191B  |hDC = 4C01191B
0018FAE0   B9051E9B  |hBitmap = B9051E9B
0018FAE4   00000000  |StartLine = 0
0018FAE8   00000096  |nLines = 96 (150.)
0018FAEC   00000000  |Buffer = NULL
0018FAF0   0018FB1C  |pBitmapinfo = 0018FB1C
0018FAF4   00000000  \Usage = DIB_RGB_COLORS
...
</code></pre></div>

<p>可以看到图像为RGB图像，第一个扫描线是150（其实就是150的高度）。查看地址0018FB1C处数据的LPBITMAPINFO结构体指针的内容：</p>
<div class="highlight"><pre><span></span><code>...
0018FB1C  28 00 00 00 C8 00 00 00 96 00 00 00 01 00 18 00  (.È..
...
</code></pre></div>

<p>根据BITMAPINFO结构体格式，发现bitmap的长度是0xC8，高度0x96，即200x150大小。</p>
<p>接着往下看：</p>
<div class="highlight"><pre><span></span><code><span class="o">...</span>
<span class="nt">00401381</span>   <span class="o">.</span>  <span class="nt">6A</span> <span class="nt">18</span>         <span class="nt">push</span> <span class="nt">0x18</span>                                <span class="o">;</span> <span class="o">/</span><span class="nt">ResourceType</span> <span class="o">=</span> <span class="nt">18</span>
<span class="nt">00401383</span>   <span class="o">.</span>  <span class="nt">6A</span> <span class="nt">65</span>         <span class="nt">push</span> <span class="nt">0x65</span>                                <span class="o">;</span> <span class="o">|</span><span class="nt">ResourceName</span> <span class="o">=</span> <span class="nt">65</span>
<span class="nt">00401385</span>   <span class="o">.</span>  <span class="nt">6A</span> <span class="nt">00</span>         <span class="nt">push</span> <span class="nt">0x0</span>                                 <span class="o">;</span> <span class="o">|</span><span class="nt">hModule</span> <span class="o">=</span> <span class="nt">NULL</span>
<span class="nt">00401387</span>   <span class="o">.</span>  <span class="nt">FF15</span> <span class="nt">7C504000</span> <span class="nt">call</span> <span class="nt">dword</span> <span class="nt">ptr</span> <span class="nt">ds</span><span class="o">:</span><span class="cp">[</span><span class="o">&lt;&amp;</span><span class="nx">KERNEL32.FindResour</span><span class="o">&gt;</span><span class="p">;</span> <span class="o">\</span><span class="nx">FindResourceA</span>
<span class="mi">0040138</span><span class="nx">D</span>   <span class="nx">.</span>  <span class="mi">50</span>            <span class="nx">push</span> <span class="nx">eax</span>                                 <span class="p">;</span> <span class="p">/</span><span class="nx">hResource</span>
<span class="mi">0040138</span><span class="nx">E</span>   <span class="nx">.</span>  <span class="mi">6</span><span class="nx">A</span> <span class="mi">00</span>         <span class="nx">push</span> <span class="mh">0x0</span>                                 <span class="p">;</span> <span class="o">|</span><span class="n">hModule</span><span class="o"> =</span> <span class="kt">NULL</span>
<span class="mi">00401390</span>   <span class="bp">.  </span><span class="nx nx-Member">FF15</span> <span class="mi">80504000</span> <span class="nx">call</span> <span class="nx">dword</span> <span class="nx">ptr</span> <span class="nx">ds</span><span class="p">:</span><span class="err">[</span><span class="o">&lt;&amp;</span><span class="nx">KERNEL32.LoadResour</span><span class="o">&gt;</span><span class="p">;</span> <span class="o">\</span><span class="nx">LoadResource</span>
<span class="mi">00401396</span>   <span class="nx">.</span>  <span class="mi">50</span>            <span class="nx">push</span> <span class="nx">eax</span>                                 <span class="p">;</span> <span class="p">/</span><span class="nx">hResource</span>
<span class="mi">00401397</span>   <span class="bp">.  </span><span class="nx nx-Member">FF15</span> <span class="mi">88504000</span> <span class="nx">call</span> <span class="nx">dword</span> <span class="nx">ptr</span> <span class="nx">ds</span><span class="p">:</span><span class="err">[</span><span class="o">&lt;&amp;</span><span class="nx">KERNEL32.LockResour</span><span class="o">&gt;</span><span class="p">;</span> <span class="o">\</span><span class="nx">LockResource</span>
<span class="nx">...</span>
</code></pre></div>

<p>之后程序从自身获取资源编号为0x65、类型是0x18的资源并加载。这里提一句，<code>FindResource()</code>返回的eax指向的数据区构造如下：</p>
<div class="highlight"><pre><span></span><code><span class="mf">0047</span><span class="n">E048</span>  <span class="mf">60</span> <span class="n">E0</span> <span class="mf">07</span> <span class="mf">00</span> <span class="mf">90</span> <span class="mf">5</span><span class="n">F</span> <span class="mf">01</span> <span class="mf">00</span> <span class="mf">00</span> <span class="mf">00</span> <span class="mf">00</span> <span class="mf">00</span> <span class="mf">00</span> <span class="mf">00</span> <span class="mf">00</span> <span class="mf">00</span>  <span class="err"></span><span class="n">徐</span><span class="err"></span><span class="mf">....</span>
<span class="mf">0047</span><span class="n">E058</span>  <span class="mf">00</span> <span class="mf">00</span> <span class="mf">00</span> <span class="mf">00</span> <span class="mf">00</span> <span class="mf">00</span> <span class="mf">00</span> <span class="mf">00</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span>  <span class="mf">........</span>
<span class="mf">0047</span><span class="n">E068</span>  <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span>  <span class="mf">........</span>
<span class="mf">...</span>
</code></pre></div>

<p>可以看到第0-4个字节0x0007E060是资源真正的起始地址的偏移，5-8个字节0x00105F90是资源大小，0047E060才是资源数据内容的起始。这就是PE文件对于资源的布局（当然不知道也能解题）。</p>
<p><code>LoadResource()</code>并Lock之后，进入如下逻辑：</p>
<div class="highlight"><pre><span></span><code><span class="p">...</span><span class="w"></span>
<span class="mi">0040139</span><span class="n">D</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">33</span><span class="n">FF</span><span class="w">          </span><span class="n">xor</span><span class="w"> </span><span class="n">edi</span><span class="p">,</span><span class="n">edi</span><span class="w"></span>
<span class="mi">0040139</span><span class="n">F</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">8</span><span class="n">BCE</span><span class="w">          </span><span class="n">mov</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="n">esi</span><span class="w"></span>
<span class="mi">004013</span><span class="n">A1</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">2</span><span class="n">BC6</span><span class="w">          </span><span class="n">sub</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="n">esi</span><span class="w"></span>
<span class="mi">004013</span><span class="n">A3</span><span class="w">   </span><span class="o">&gt;</span><span class="w">  </span><span class="mi">8</span><span class="n">A11</span><span class="w">          </span><span class="n">mov</span><span class="w"> </span><span class="n">dl</span><span class="p">,</span><span class="n">byte</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">ds</span><span class="p">:</span><span class="o">[</span><span class="n">ecx</span><span class="o">]</span><span class="w"></span>
<span class="mi">004013</span><span class="n">A5</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">8</span><span class="n">A1C08</span><span class="w">        </span><span class="n">mov</span><span class="w"> </span><span class="n">bl</span><span class="p">,</span><span class="n">byte</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="nl">ds</span><span class="p">:</span><span class="o">[</span><span class="n">eax+ecx</span><span class="o">]</span><span class="w"></span>
<span class="mi">004013</span><span class="n">A8</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">3</span><span class="n">AD3</span><span class="w">          </span><span class="n">cmp</span><span class="w"> </span><span class="n">dl</span><span class="p">,</span><span class="n">bl</span><span class="w"></span>
<span class="mi">004013</span><span class="n">AA</span><span class="w">      </span><span class="mi">75</span><span class="w"> </span><span class="mi">21</span><span class="w">         </span><span class="n">jnz</span><span class="w"> </span><span class="n">XImagePrc</span><span class="mf">.004013</span><span class="n">CD</span><span class="w"></span>
<span class="mi">004013</span><span class="n">AC</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">47</span><span class="w">            </span><span class="n">inc</span><span class="w"> </span><span class="n">edi</span><span class="w"></span>
<span class="mi">004013</span><span class="n">AD</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">41</span><span class="w">            </span><span class="n">inc</span><span class="w"> </span><span class="n">ecx</span><span class="w"></span>
<span class="mi">004013</span><span class="n">AE</span><span class="w">      </span><span class="mi">81</span><span class="n">FF</span><span class="w"> </span><span class="mi">905</span><span class="n">F0100</span><span class="w"> </span><span class="n">cmp</span><span class="w"> </span><span class="n">edi</span><span class="p">,</span><span class="mh">0x15F90</span><span class="w"></span>
<span class="mi">004013</span><span class="n">B4</span><span class="w">   </span><span class="p">.</span><span class="o">^</span><span class="w"> </span><span class="mi">7</span><span class="n">C</span><span class="w"> </span><span class="n">ED</span><span class="w">         </span><span class="n">jl</span><span class="w"> </span><span class="n">XImagePrc</span><span class="mf">.004013</span><span class="n">A3</span><span class="w"></span>
<span class="mi">004013</span><span class="n">B6</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">56</span><span class="w">            </span><span class="n">push</span><span class="w"> </span><span class="n">esi</span><span class="w"></span>
<span class="mi">004013</span><span class="n">B7</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="n">E8</span><span class="w"> </span><span class="mi">44010000</span><span class="w">   </span><span class="k">call</span><span class="w"> </span><span class="n">ImagePrc</span><span class="mf">.00401500</span><span class="w"></span>
<span class="mi">004013</span><span class="n">BC</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">83</span><span class="n">C4</span><span class="w"> </span><span class="mi">04</span><span class="w">       </span><span class="k">add</span><span class="w"> </span><span class="n">esp</span><span class="p">,</span><span class="mh">0x4</span><span class="w"></span>
<span class="mi">004013</span><span class="n">BF</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">33</span><span class="n">C0</span><span class="w">          </span><span class="n">xor</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="n">eax</span><span class="w"></span>
<span class="mi">004013</span><span class="n">C1</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">5</span><span class="n">B</span><span class="w">            </span><span class="n">pop</span><span class="w"> </span><span class="n">ebx</span><span class="w"></span>
<span class="mi">004013</span><span class="n">C2</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">5</span><span class="n">F</span><span class="w">            </span><span class="n">pop</span><span class="w"> </span><span class="n">edi</span><span class="w"></span>
<span class="mi">004013</span><span class="n">C3</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">5</span><span class="n">E</span><span class="w">            </span><span class="n">pop</span><span class="w"> </span><span class="n">esi</span><span class="w"></span>
<span class="mi">004013</span><span class="n">C4</span><span class="w">   </span><span class="p">.</span><span class="w">  </span><span class="mi">81</span><span class="n">C4</span><span class="w"> </span><span class="mi">80000000</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="n">esp</span><span class="p">,</span><span class="mh">0x80</span><span class="w"></span>
<span class="mi">004013</span><span class="n">CA</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">.</span><span class="w">  </span><span class="n">C2</span><span class="w"> </span><span class="mi">1000</span><span class="w">       </span><span class="n">retn</span><span class="w"> </span><span class="mh">0x10</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</code></pre></div>

<p>这段逻辑很简单，一个循环，一共循环0x15F90次（刚好是上面分析的资源的大小）。之后把绘制的图像数据和资源图像数据分别放入dl和bl进行每个byte的逐一比较。一开始我以为只要比较结果正确就能拿到flag，所以直接修改比较次数为0，可惜程序正常执行，却没有flag的踪迹。所以思路转为从资源入手。</p>
<h1>资源操作</h1>
<p>打开exeScope之类的资源提取工具，提取编号0x65的资源，发现大小是0X15F80，比我们需要的数据小0x10个字节。于是重新跟程序到<code>LoadResource()</code>执行后，eax为47e060，提取47e060-493ff0一共0X15F90字节所有数据到文件。发现其实最后0x10个字节直接被填充为全0。</p>
<p>二进制文件提取出来后，需要让它作为图像显示出来。文件大小为0X15F90，十进制是90000，相当于200x150x3，也就是200x150的RGB三通道图像。我这边直接利用Python的<a href="https://github.com/python-pillow/Pillow/">Pillow图像处理库</a>做还原（Python3的PIL为Pillow）：</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="n">width</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">height</span> <span class="o">=</span> <span class="mi">150</span>

<span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;rgb.mem&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_TOP_BOTTOM</span><span class="p">)</span>
<span class="n">im</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;result.bmp&#39;</span><span class="p">)</span>
</code></pre></div>

<p>提取后发现图片是上下颠倒的，不知道是由于作者故意做成颠倒的还是WinAPI中GetDIBits是倒着读的。所以使用<code>transpose()</code>做翻转。之后可以看到作者绘制的内容为GOT三个字符，即为flag。</p>
        </section>

        <br>

        <footer>
          <!-- <div class="adjust-width">
            <div id="author-block" class="w3-light-grey w3-border">
              <div id="author-info">
                <a href=""><img style="width: 60px; height: 60px;" src="/theme/images/cat_avatar.png" onerror="this.src='theme/images/avatar.png'" alt="Avatar"></a>
                <div style="margin-left: 20px; margin-top: 15px;">
                  <a href=""><span id="author-name" class="w3-hover-text-dark-grey">YYX</span></a>
                  <p id="author-story"></p>
                </div>
              </div>
            </div>
          </div>

          <br><br><br> -->

          <p style="font-size:10pt; font-style: italic;">Did you like this article? Share it with your friends!</p>
          <div id="share" class="share">
            <a href="http://www.facebook.com/sharer.php?u=https%3A//blog.yyx.me/posts/reversing-kr-imageprc/&amp;t=YYX%27s%20Website%3A%20reversing.kr%20ImagePrc%20Walkthrough" target="_blank" class="w3-btn yyx-btn-hover">
              <i class="fa fa-facebook"></i> <!-- <span>Facebook</span> -->
            </a>
            <a href="http://twitter.com/share?url=https%3A//blog.yyx.me/posts/reversing-kr-imageprc/&amp;text=YYX%27s%20Website%3A%20reversing.kr%20ImagePrc%20Walkthrough" target="_blank" class="w3-btn yyx-btn-hover">
              <i class="fa fa-twitter"></i> <!-- <span>Twitter</span> -->
            </a>
            <a href="https://plus.google.com/share?url=https%3A//blog.yyx.me/posts/reversing-kr-imageprc/" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;" class="w3-btn yyx-btn-hover">
              <i class="fa fa-google-plus"></i> <!-- <span>Google</span> -->
            </a>
          </div>

          <br><br><br>


<div id="disqus_thread" class="w3-margin-bottom"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT 
     *  THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR 
     *  PLATFORM OR CMS.
     *  
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: 
     *  https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        // Replace PAGE_URL with your page's canonical URL variable
        this.page.url = PAGE_URL;  
        
        // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        this.page.identifier = PAGE_IDENTIFIER; 
    };
    */
    
    (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document, s = d.createElement('script');
        
        // IMPORTANT: Replace EXAMPLE with your forum shortname!
        s.src = 'https://yyxblog.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>
    Please enable JavaScript to view the 
    <a href="https://disqus.com/?ref_noscript" rel="nofollow">
        comments powered by Disqus.
    </a>
</noscript>

        </footer>
      </div>
    </article>


    <footer id="footer">
      <div id="footer-copyright" class="w3-center w3-text-grey w3-padding-48">
        <span>
          &copy;
          2014&dash;2021          yyx.me
 | <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank"><i class="fa fa-creative-commons" aria-hidden="true"></i></a>        </span>
      </div>
    </footer>

    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-64342434-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>